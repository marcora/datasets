<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Chat with the Goate lab datasets</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

  <!-- Code highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

  <style>
    [x-cloak] {
      display: none !important;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 antialiased">

  <div class="min-h-screen flex justify-center py-10 px-4">
    <div class="w-full max-w-5xl" x-data="chatbot()">

      <!-- Header (Penguin UI default: simple, neutral) -->
      <div class="mb-4">
        <h1 class="text-xl font-semibold text-slate-900">
          Chat with the Goate lab datasets
        </h1>
        <p class="text-sm text-slate-600">
          Ask questions about Goate lab datasets, samples, and README.qmd files.
        </p>
      </div>

      <!-- Chat card -->
      <div class="bg-white border border-slate-200 rounded-lg shadow-sm flex flex-col h-[60vh] min-h-[420px]">

        <!-- Chat body -->
        <div id="chat" class="flex-1 overflow-y-auto p-4 space-y-4">
          <template x-for="msg in messages" :key="msg.id">
            <div class="flex" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
              <div class="max-w-[80%]">

                <!-- Message bubble -->
                <div class="rounded-lg px-3 py-2 text-sm leading-relaxed" :class="msg.role === 'user'
                  ? 'bg-slate-100 text-slate-900'
                  : 'bg-white border border-slate-200 text-slate-900'" x-html="msg.role === 'assistant'
                  ? renderMarkdown(msg.text)
                  : escapeHtml(msg.text)">
                </div>

              </div>
            </div>
          </template>
        </div>

        <!-- Divider -->
        <div class="border-t border-slate-200"></div>

        <!-- Sources + status -->
        <div class="px-4 py-2 flex flex-wrap items-center gap-2 text-xs">

          <!-- Dataset chips -->
          <div class="flex flex-wrap gap-1.5" x-show="sources.length">
            <template x-for="s in sources" :key="s.dataset_id">
              <button class="rounded-full border border-slate-300 px-2.5 py-1 text-slate-700 hover:bg-slate-100"
                @click="loadDataset(s.dataset_id)" x-text="s.dataset_id">
              </button>
            </template>
          </div>

          <!-- Status -->
          <span class="ml-auto text-slate-500" x-text="status"></span>
        </div>

        <!-- Divider -->
        <div class="border-t border-slate-200"></div>

        <!-- Input -->
        <form @submit.prevent="send" class="p-4">
          <div class="flex gap-2">
            <input x-model="input" type="text" placeholder="Ask a question…"
              class="flex-1 rounded-md border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400"
              autocomplete="off" />
            <button type="submit" class="rounded-md bg-slate-900 text-white px-4 py-2 text-sm hover:bg-slate-800"
              :disabled="status === 'Thinking…'">
              Send
            </button>
          </div>
        </form>
      </div>

      <!-- Dataset details -->
      <div class="mt-6" x-show="selectedDatasetId" x-cloak>
        <div class="bg-white border border-slate-200 rounded-lg p-4">

          <div class="mb-3">
            <h2 class="text-sm font-semibold">
              Dataset: <span class="font-mono" x-text="selectedDatasetId"></span>
            </h2>
            <p class="text-xs text-slate-600">
              README metadata and body.
            </p>
          </div>

          <!-- Metadata -->
          <div x-show="Object.keys(datasetDetails?.metadata || {}).length" class="mb-4">
            <h3 class="text-xs font-semibold mb-1">Metadata</h3>
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs">
              <template x-for="entry in Object.entries(datasetDetails.metadata || {})" :key="entry[0]">
                <div>
                  <dt class="inline font-medium text-slate-500" x-text="entry[0] + ':'"></dt>
                  <dd class="inline ml-1" x-text="Array.isArray(entry[1]) ? entry[1].join(', ') : String(entry[1])">
                  </dd>
                </div>
              </template>
            </dl>
          </div>

          <!-- README -->
          <div x-show="datasetDetails?.body_markdown">
            <h3 class="text-xs font-semibold mb-1">README</h3>
            <div class="prose prose-sm max-w-none" x-html="renderMarkdown(datasetDetails.body_markdown)">
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    function chatbot() {
      return {
        input: "",
        messages: [],
        sources: [],
        status: "Ready",

        selectedDatasetId: null,
        datasetDetails: null,

        escapeHtml(txt) {
          const d = document.createElement('div');
          d.textContent = txt;
          return d.innerHTML;
        },

        renderMarkdown(raw) {
          if (!raw) return "";
          const html = marked.parse(raw, {gfm: true, breaks: true});
          const clean = DOMPurify.sanitize(html);
          const tmp = document.createElement("div");
          tmp.innerHTML = clean;
          tmp.querySelectorAll('pre code').forEach(b => {
            try {hljs.highlightElement(b);} catch { }
          });
          return tmp.innerHTML;
        },

        async send() {
          if (!this.input.trim()) return;
          const q = this.input.trim();
          this.messages.push({id: Date.now(), role: "user", text: q});
          this.input = "";
          this.status = "Thinking…";
          this.sources = [];

          try {
            const r = await fetch("/chat", {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({message: q})
            });
            const data = await r.json();
            this.messages.push({id: Date.now() + 1, role: "assistant", text: data.answer || ""});

            const raw = (data.sources || []).map(s => ({dataset_id: s.dataset_id}));
            this.sources = Array.from(new Map(raw.map(s => [s.dataset_id, s])).values());

            this.status = "Ready";
            this.$nextTick(() => {
              const c = document.getElementById("chat");
              c.scrollTop = c.scrollHeight;
            });
          } catch {
            this.messages.push({id: Date.now() + 2, role: "assistant", text: "Error contacting server."});
            this.status = "Error";
          }
        },

        async loadDataset(id) {
          this.selectedDatasetId = id;
          this.datasetDetails = null;
          const r = await fetch(`/dataset/${encodeURIComponent(id)}`);
          this.datasetDetails = await r.json();
          this.$nextTick(() => {
            document.querySelector('[x-cloak]').scrollIntoView({behavior: 'smooth'});
          });
        }
      }
    }
  </script>

</body>

</html>