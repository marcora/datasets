<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Lab Knowledge Chatbot</title>

  <!-- Tailwind via CDN (no build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              DEFAULT: '#4f46e5',
              soft: '#eef2ff'
            }
          }
        }
      }
    };
  </script>

  <!-- Alpine -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Markdown -> HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

  <!-- highlight.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

  <style>
    /* small helper so x-cloak hides until Alpine inits */
    [x-cloak] {
      display: none !important;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 antialiased">

  <div class="min-h-screen flex items-start justify-center py-10 px-4 sm:px-6 lg:px-8">
    <div class="w-full max-w-5xl" x-data="chatbot()" x-init="">
      <!-- Header -->
      <div class="flex items-center gap-3 mb-4">
        <div
          class="h-11 w-11 rounded-xl bg-gradient-to-br from-indigo-500 to-sky-400 flex items-center justify-center text-white font-semibold shadow-lg">
          KB
        </div>
        <div>
          <h1 class="text-xl font-semibold tracking-tight">Lab Knowledge Chatbot</h1>
          <p class="text-sm text-slate-500">Ask questions about your datasets, samples, and README.qmd files.</p>
        </div>
      </div>

      <!-- Chat card -->
      <div class="bg-white shadow-lg rounded-2xl border border-slate-200 flex flex-col h-[60vh] min-h-[420px]">
        <!-- Chat area -->
        <div id="chat" class="flex-1 overflow-y-auto px-4 sm:px-5 py-4 space-y-3">
          <template x-for="msg in messages" :key="msg.id">
            <div class="flex gap-3" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
              <!-- Avatar -->
              <template x-if="msg.role === 'assistant'">
                <div
                  class="flex-shrink-0 h-9 w-9 rounded-full bg-indigo-50 border border-indigo-100 flex items-center justify-center text-xs font-semibold text-indigo-600">
                  AI</div>
              </template>
              <template x-if="msg.role === 'user'">
                <div
                  class="flex-shrink-0 h-9 w-9 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-xs font-semibold text-slate-600">
                  You</div>
              </template>

              <!-- Bubble -->
              <div class="max-w-[80%]">
                <div class="rounded-2xl px-3.5 py-2.5 text-sm leading-relaxed shadow-sm"
                  :class="msg.role === 'user' ? 'bg-brand-soft text-slate-900' : 'bg-slate-50 border border-slate-200 text-slate-900'"
                  x-html="msg.role === 'assistant' ? renderMarkdown(msg.text) : escapeHtml(msg.text)">
                </div>
              </div>
            </div>
          </template>
        </div>

        <!-- Sources + status -->
        <div class="px-4 sm:px-5 py-2 border-t border-slate-200 flex flex-wrap items-center gap-2 justify-between">
          <!-- Dataset badges -->
          <div class="flex flex-wrap gap-1.5" x-show="sources && sources.length">
            <template x-for="s in sources" :key="s.dataset_id">
              <button type="button"
                class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-1 text-xs font-medium text-slate-700 border border-slate-200 hover:bg-slate-200 transition cursor-pointer"
                @click="loadDataset(s.dataset_id)" x-text="s.dataset_id">
              </button>
            </template>
          </div>

          <!-- Status pill -->
          <div class="ml-auto">
            <span
              class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-1 text-xs font-medium text-slate-500 border border-slate-200">
              <span class="w-1.5 h-1.5 rounded-full mr-1.5"
                :class="status === 'Ready' ? 'bg-emerald-500' : (status === 'Error' ? 'bg-rose-500' : 'bg-amber-400')"></span>
              <span x-text="status"></span>
            </span>
          </div>
        </div>

        <!-- Input -->
        <form @submit.prevent="send" class="px-4 sm:px-5 py-3 border-t border-slate-200">
          <div class="flex gap-2 items-center">
            <input x-model="input" type="text" placeholder="Ask about datasets, samples, QC…"
              class="flex-1 rounded-xl border border-slate-300 bg-white px-3.5 py-2.5 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-brand/60 focus:border-brand"
              autocomplete="off" />
            <button type="submit"
              class="inline-flex items-center gap-1.5 rounded-xl bg-gradient-to-r from-indigo-500 to-sky-500 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:from-indigo-600 hover:to-sky-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
              :disabled="status === 'Thinking…'">
              <span x-show="status !== 'Thinking…'">Send</span>
              <span x-show="status === 'Thinking…'">Thinking…</span>
            </button>
          </div>
        </form>
      </div>

      <!-- Dataset details panel (below chat) -->
      <div class="mt-6" x-show="selectedDatasetId" x-cloak>
        <div class="bg-white shadow-md rounded-2xl border border-slate-200 p-5">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="text-sm font-semibold text-slate-800">
                Dataset: <span class="font-mono text-indigo-600" x-text="selectedDatasetId"></span>
              </h2>
              <p class="text-xs text-slate-500">README metadata and body rendered below. Click another badge to switch.
              </p>
            </div>
            <div class="text-xs text-slate-500">
              <span x-show="loadingDataset">Loading…</span>
            </div>
          </div>

          <!-- Metadata -->
          <div x-show="datasetDetails && Object.keys(datasetDetails.metadata || {}).length" class="mb-3">
            <h3 class="text-xs font-semibold text-slate-700 mb-1">Metadata</h3>
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-slate-700">
              <template x-for="entry in Object.entries(datasetDetails?.metadata || {})" :key="entry[0]">
                <div class="flex">
                  <dt class="font-medium text-slate-500 mr-1" x-text="entry[0] + ':'"></dt>
                  <dd x-text="Array.isArray(entry[1]) ? entry[1].join(', ') : String(entry[1])"></dd>
                </div>
              </template>
            </dl>
          </div>

          <!-- README body -->
          <div x-show="datasetDetails && datasetDetails.body_markdown">
            <h3 class="text-xs font-semibold text-slate-700 mb-1">README</h3>
            <div class="prose prose-sm max-w-none prose-slate" x-html="renderMarkdown(datasetDetails.body_markdown)">
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    function chatbot() {
      return {
        input: "",
        messages: [],
        sources: [],
        status: "Ready",

        // dataset panel state
        selectedDatasetId: null,
        datasetDetails: null,
        loadingDataset: false,

        escapeHtml(txt) {
          const div = document.createElement('div');
          div.appendChild(document.createTextNode(txt));
          return div.innerHTML;
        },

        renderMarkdown(raw) {
          if (!raw) return "";
          const html = marked.parse(raw, {gfm: true, breaks: true});

          const doc = new DOMParser().parseFromString(html, "text/html");
          doc.querySelectorAll("a").forEach(a => {
            a.setAttribute("target", "_blank");
            a.setAttribute("rel", "noopener noreferrer");
          });
          const withTargets = doc.body.innerHTML;

          const clean = DOMPurify.sanitize(withTargets, {
            ALLOWED_ATTR: ['href', 'target', 'rel', 'class', 'id', 'src', 'alt', 'title', 'aria-hidden'],
          });

          const tmp = document.createElement("div");
          tmp.innerHTML = clean;
          tmp.querySelectorAll('pre code').forEach((block) => {
            try {hljs.highlightElement(block);} catch (e) { /* ignore */}
          });
          return tmp.innerHTML;
        },

        async send() {
          if (!this.input || this.input.trim() === "") return;
          const question = this.input.trim();

          // add user message
          this.messages.push({id: Date.now(), role: "user", text: question});
          this.input = "";
          this.status = "Thinking…";
          this.sources = [];

          try {
            const resp = await fetch("/chat", {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({message: question})
            });

            if (!resp.ok) {
              throw new Error(`HTTP ${resp.status}`);
            }
            const data = await resp.json();

            // assistant message
            this.messages.push({
              id: Date.now() + 1,
              role: "assistant",
              text: data.answer || "[no answer]"
            });

            // dataset badges (dedupe)
            const rawSources = (data.sources || []).map(s => ({dataset_id: s.dataset_id}));
            this.sources = Array.from(new Map(rawSources.map(s => [s.dataset_id, s])).values());

            this.status = "Ready";

            this.$nextTick(() => {
              const chat = document.getElementById("chat");
              chat.scrollTop = chat.scrollHeight;
            });

          } catch (e) {
            console.error(e);
            this.messages.push({id: Date.now() + 2, role: "assistant", text: "Error contacting server."});
            this.status = "Error";
          }
        },

        async loadDataset(datasetId) {
          if (!datasetId) return;
          this.selectedDatasetId = datasetId;
          this.datasetDetails = null;
          this.loadingDataset = true;
          try {
            const resp = await fetch(`/dataset/${encodeURIComponent(datasetId)}`);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();
            this.datasetDetails = data;
            // scroll to details panel
            this.$nextTick(() => {
              const el = document.querySelector('[x-cloak]') || document.querySelector('.mt-6');
              if (el) el.scrollIntoView({behavior: 'smooth', block: 'start'});
            });
          } catch (e) {
            console.error(e);
            this.datasetDetails = {dataset_id: datasetId, metadata: {}, body_markdown: "_Error loading dataset details._"};
          } finally {
            this.loadingDataset = false;
          }
        }
      }
    }
  </script>

</body>

</html>